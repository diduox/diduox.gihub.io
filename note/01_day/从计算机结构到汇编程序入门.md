#### 从计算机结构到汇编程序入门

##### 1.二进制编辑器

通过二进制编辑器直接写成.img格式的文件

> **IMG**是一种文件归档格式（archive format），主要是为了建立磁盘的映像文件（disk image），它可以用来封装存储整个磁盘（通常指软磁盘，Floppy Disk或Diskette）或整片光盘的内容，使用".IMG"这个[扩展名](https://zh.wikipedia.org/wiki/文件扩展名)的文件就是利用这种文件格式来建立的。

##### 2.汇编程序

利用作者自己的汇编器**NASK**，来使汇编文件生成img文件

```bash
..\z_tools\nask.exe helloos.nas helloos.img
```

##### 3.汇编源码

此源码采用FAT12软盘格式

> 说起来 FAT12 文件系统的历史相当久远，早在 DOS 系统的时代就使用 FAT12 作为文件系统使用，一直沿用至今仍会在软盘的结构上使用 FAT12 格式。
>
> 当软盘以 FAT12 格式组织格式化后将会以如下标准设定：
>
> 两个磁头；
> 每个磁头有 80 个磁道；
> 每个磁道有 18 个扇区；
> 每个扇区大小为 512 字节。
> 标准 FAT12 软盘空间：2 * 80 * 18 * 512 = 1474560B = 1440KB = 1.44MB

NASM的伪指令

> DB："define byte"的缩写，就是直接往文件里写入一个字节的指令
>
> 我们可以直接用DB指令写字符串。在写字符串的时候，汇编语言会自动地查找字符串中每一个字符所对应的编码，然后把他们一个字节一个字节的排列起来。
>
> RESB:"reserve byte"的缩写，如果我们想从当前的位置空出十个字符 我们可以写成RESB 10
>
> 在作者自行开发的NASK中 RESB不仅会将位置空出来 还会向其填入 0x00
>
> DW: "define word"  写入两个字节
>
> DD: "define double-word" 写入四个字节

```assembly
; hello-os
; TAB=4

; 以下这段是标准FAT12格式磁盘专用的代码

		DB		0xeb, 0x4e, 0x90
		DB		"HELLOIPL"		; 启动区的名称可以是任意的字符串（8字节）
		DW		512				; 每个扇区的大小（必须为512字节）
		DB		1				; 簇的大小（必须为一个扇区1）
		DW		1				; FAT的起始位置（一般从第一个扇区开始）
		DB		2				; FAT的个数（必须为2）
		DW		224				; 根目录的大小（一般设为224项）
		DW		2880			; 该磁盘的大小（必须是2880扇区）
		DB		0xf0			; 磁盘的种类（必须是0xf0）
		DW		9				; FAT的长度（必须是9扇区）
		DW		18				; 1个磁道（track）有几个扇区（必须是18）
		DW		2				; 磁头数（必须是2）
		DD		0				; 不使用分区，必须是0
		DD		2880			; 重写一次磁盘大小
		DB		0,0,0x29		; 意义不明，固定码
		DD		0xffffffff		; （可能是）卷标号码
		DB		"HELLO-OS   "	; 磁盘的名称（11字节）
		DB		"FAT12   "		; 磁盘格式名称（8字节）
		RESB	18				; 先空出18字节

; 程序主体

		DB		0xb8, 0x00, 0x00, 0x8e, 0xd0, 0xbc, 0x00, 0x7c
		DB		0x8e, 0xd8, 0x8e, 0xc0, 0xbe, 0x74, 0x7c, 0x8a
		DB		0x04, 0x83, 0xc6, 0x01, 0x3c, 0x00, 0x74, 0x09
		DB		0xb4, 0x0e, 0xbb, 0x0f, 0x00, 0xcd, 0x10, 0xeb
		DB		0xee, 0xf4, 0xeb, 0xfd

; 信息显示部分

		DB		0x0a, 0x0a		; 2个换行
		DB		"hello, world"
		DB		0x0a			; 换行
		DB		0

		RESB	0x1fe-$			; 填写0x00，直到0x001fe
								; $是一个变量 我们已经在前面输出了132字节，这里的$就是132
								; 为了确保占据512字节 即一个扇区
		DB		0x55, 0xaa		; 启动盘定义 详见下面定义

; 以下是启动区以外部分的输出

		DB		0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
		RESB	4600
		DB		0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
		RESB	1469432

```

> 启动区 (boot sector)软盘第一个的扇区称为启动区。
>
> 那么什么是扇区呢?计算机读写软盘的时候，并不是一个字节一个字节地读写的，而是以512字节为一个单位进行读写。因此,软盘的512字 节就称为一个扇区。一张软盘的空间共有1440KB，也就是1474560字节，除以512得2880,这也就是说一张软盘共有2880个扇区。那为什么第一个扇区称为启动区呢?那是因为计算机首先从最初一个扇区开始读软盘，然后去检查这个扇区最后2个字节的内容。
> 如果这最后2个字节不是0x55AA,计算机会认为这张盘上没有所需的启动程序，就会报一个不能启动的错误。( 也许有人会问为什么一定是0x55 AA呢?那是当初的设计者随便定的，笔者也没法解释)。如果计算机确认了第一个扇区的最后两个字节正好是0x55AA,那它就认为这个扇区的开头是启动程序，并开始执行这个程序。